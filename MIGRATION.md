# サーバー側アーキテクチャへの移行完了

## 概要

クライアント側のIndexedDBからサーバー側のファイルベースストレージへの移行が完了しました。

## 主な変更点

### 1. 認証システムの追加
- **ログインページ**: `app/login/page.tsx`
  - ニックネームのみの簡易ログイン
  - パスワード不要（本番環境では要改善）
  - localStorageにニックネームを保存

- **認証API**: `app/api/auth/login/route.ts`
  - ユーザー作成・取得
  - `data/users/` ディレクトリにユーザー情報を保存

### 2. セッション管理の変更

#### サーバー側API
- **セッション開始API**: `app/api/session/start/route.ts`
  - ランダムな銘柄を1つ選択
  - 必要な価格データのみを返す（120日の過去データ + 練習期間）
  - クライアントに送信するデータサイズを大幅に削減（37MB→数百KB）

- **セッション保存・取得API**: `app/api/sessions/route.ts`
  - POST: セッションの保存・更新
  - GET: ユーザーのセッション一覧取得
  - `data/sessions/` ディレクトリにユーザーごとのファイルで保存

- **セッション詳細API**: `app/api/sessions/[sessionId]/route.ts`
  - GET: 特定セッションの取得
  - PUT: 特定セッションの更新

#### クライアント側の変更

**ホームページ** (`app/page.tsx`):
- IndexedDBの代わりにAPI経由でセッションを読み込み
- ログインチェックを追加
- ログアウト機能を追加
- ユーザーのニックネームを表示

**セッション作成ページ** (`app/session/new/page.tsx`):
- IndexedDBとクライアント側の銘柄選択を削除
- `/api/session/start` を呼び出してサーバーから銘柄と価格データを取得
- セッションデータにニックネームを含める
- サーバーに保存

**セッション実行ページ** (`app/session/[sessionId]/page.tsx`):
- セッションデータをサーバーから読み込み
- すべての変更（注文、ポジション決済、ルール違反）をサーバーに保存
- 価格データはセッションオブジェクトに含まれるため、別途読み込み不要

**履歴ページ** (`app/history/page.tsx`):
- IndexedDBの代わりにAPI経由でセッションを読み込み
- 削除処理もAPI経由で実行

### 3. データ構造の変更

**セッションオブジェクトに追加されたフィールド**:
```typescript
{
  nickname: string,        // ユーザーのニックネーム
  prices: PriceData[],     // 価格データ（セッションごとに保存）
  positions: Position[],   // ポジション一覧
  trades: Trade[],         // 取引履歴
  violations: Violation[], // ルール違反一覧
}
```

### 4. 削除されたファイル/機能
- ~~IndexedDB操作コード~~ → APIコールに置き換え
- ~~useLiveQuery hooks~~ → useState + API fetchに置き換え
- ~~クライアント側の銘柄データキャッシュ~~ → サーバー側で管理

## ファイル構造

```
data/
  users/
    {nickname}.json     # ユーザー情報
  sessions/
    {nickname}.json     # ユーザーのセッション一覧
public/
  cache/
    stocks.json         # 全銘柄情報（サーバー側で使用）
    prices.json         # 全価格データ（サーバー側で使用）
```

## セキュリティ上の注意

現在の実装は開発/学習用です。本番環境では以下の改善が必要です：

1. **認証**: パスワードベースの認証に変更
2. **トークン**: JWTなどの適切なトークン管理
3. **データベース**: ファイルシステムからPostgreSQL/MongoDBへ移行
4. **セッション管理**: サーバー側のセッション管理を強化
5. **バリデーション**: 入力データの検証を強化

## 利点

1. **データサイズの削減**: クライアントは必要な銘柄1つのデータのみ受け取る
2. **データの永続性**: ブラウザのデータ削除の影響を受けない
3. **複数デバイス対応**: 同じアカウントで複数デバイスからアクセス可能
4. **サーバー側の処理**: 銘柄選択などをサーバー側で処理
5. **スケーラビリティ**: データベースへの移行が容易

## 使い方

1. アプリケーションを起動: `npm run dev`
2. `http://localhost:3000` にアクセス
3. ニックネームを入力してログイン
4. 新規セッションを作成して練習開始

## 今後の改善点

- [ ] データベース（PostgreSQL/MongoDB）への移行
- [ ] パスワードベースの認証
- [ ] セッションタイムアウト処理
- [ ] エラーハンドリングの強化
- [ ] ユニットテストの追加
- [ ] APIレート制限の実装
